# PR è‡ªåŠ¨å®¡æŸ¥ - è¯­æ³•æ£€æŸ¥ + AI è¯­ä¹‰å®¡æŸ¥
# å½“æœ‰ PR åˆ›å»ºæˆ–æ›´æ–°æ—¶è‡ªåŠ¨è§¦å‘

name: PR Review

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - '**.py'
      - '**.md'
      - 'docs/**'
      - 'README.md'
      - 'AGENTS.md'
      - 'requirements.txt'
      - 'pyproject.toml'
      - 'setup.cfg'
      - '.github/PULL_REQUEST_TEMPLATE.md'
      - '.github/workflows/**'
      - '.github/scripts/**'
      - 'docker/Dockerfile'
      - 'docker-compose.yml'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºé‡æ–°å®¡æŸ¥ï¼‰
  workflow_dispatch:

# é™åˆ¶å¹¶å‘ï¼Œé¿å…åŒä¸€ PR å¤šæ¬¡è§¦å‘æ—¶é‡å¤è¯„è®º
concurrency:
  group: pr-review-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ==================== å®‰å…¨æ£€æŸ¥ï¼ˆæ£€æµ‹æ•æ„Ÿæ–‡ä»¶ä¿®æ”¹ï¼‰====================
  security-check:
    name: ğŸ”’ å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      safe_to_run: ${{ steps.check_sensitive.outputs.safe_to_run }}
      sensitive_files_changed: ${{ steps.check_sensitive.outputs.sensitive_files_changed }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0
      
      - name: ğŸ”„ è·å– base åˆ†æ”¯
        run: git fetch origin ${{ github.base_ref || 'main' }}:refs/remotes/origin/${{ github.base_ref || 'main' }}
      
      - name: ğŸ”’ æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶ä¿®æ”¹
        id: check_sensitive
        run: |
          BASE_REF="${{ github.base_ref || 'main' }}"
          SENSITIVE_FILES=$(git diff --name-only origin/$BASE_REF...HEAD | grep -E '^(\.github/workflows/.*\.yml|\.github/scripts/.*\.py)$' || echo "")
          
          if [ -n "$SENSITIVE_FILES" ]; then
            echo "âš ï¸ **æ£€æµ‹åˆ°æ•æ„Ÿæ–‡ä»¶ä¿®æ”¹ï¼Œéœ€è¦äººå·¥å®¡æ ¸ï¼**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ä¿®æ”¹çš„æ•æ„Ÿæ–‡ä»¶ï¼š" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$SENSITIVE_FILES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å·²æ ‡è®°ä¸ºæ•æ„Ÿå˜æ›´ï¼Œè¯·é‡ç‚¹äººå·¥å¤æ ¸ï¼›è‡ªåŠ¨æµç¨‹ç»§ç»­æ‰§è¡Œã€‚" >> $GITHUB_STEP_SUMMARY
            echo "sensitive_files_changed=true" >> $GITHUB_OUTPUT
            echo "safe_to_run=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… æœªæ£€æµ‹åˆ°æ•æ„Ÿæ–‡ä»¶ä¿®æ”¹" >> $GITHUB_STEP_SUMMARY
            echo "sensitive_files_changed=false" >> $GITHUB_OUTPUT
            echo "safe_to_run=true" >> $GITHUB_OUTPUT
          fi

  # ==================== é™æ€æ£€æŸ¥ï¼ˆå…ˆäº AI å®¡æŸ¥ï¼‰====================
  auto-check:
    name: ğŸ” é™æ€æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [security-check]
    if: needs.security-check.outputs.safe_to_run == 'true'
    outputs:
      syntax_ok: ${{ steps.syntax.outputs.syntax_ok }}
      has_py_changes: ${{ steps.check_files.outputs.has_py_changes }}
      has_reviewable_changes: ${{ steps.check_files.outputs.has_reviewable_changes }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0
      
      - name: ğŸ”„ è·å– base åˆ†æ”¯
        run: git fetch origin ${{ github.base_ref || 'main' }}:refs/remotes/origin/${{ github.base_ref || 'main' }}
      
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install flake8
      
      - name: ğŸ“‹ æ£€æŸ¥å˜æ›´æ–‡ä»¶
        id: check_files
        run: |
          BASE_REF="${{ github.base_ref || 'main' }}"
          CHANGED_FILES=$(git diff --name-only origin/$BASE_REF...HEAD -- '*.py' 2>/dev/null || echo "")
          REVIEWABLE_FILES=$(git diff --name-only origin/$BASE_REF...HEAD -- '*.py' '*.md' 'docs/**' 'README.md' 'AGENTS.md' 'requirements.txt' 'pyproject.toml' 'setup.cfg' '.github/PULL_REQUEST_TEMPLATE.md' '.github/workflows/**' '.github/scripts/**' 2>/dev/null || echo "")

          if [ -z "$REVIEWABLE_FILES" ]; then
            echo "has_reviewable_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_reviewable_changes=true" >> $GITHUB_OUTPUT
          fi

          if [ -z "$CHANGED_FILES" ]; then
            echo "has_py_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… æ²¡æœ‰ä¿®æ”¹ Python æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_py_changes=true" >> $GITHUB_OUTPUT
            echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
            echo "$CHANGED_FILES" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi
      
      - name: ğŸ Python è¯­æ³•æ£€æŸ¥
        id: syntax
        if: steps.check_files.outputs.has_py_changes == 'true'
        run: |
          echo "## ğŸ è¯­æ³•æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "æ£€æŸ¥æ–‡ä»¶: $CHANGED_FILES"
          
          ERRORS=""
          SYNTAX_OK="true"
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              if ! python -m py_compile "$file" 2>&1; then
                ERRORS="$ERRORS\nâŒ $file è¯­æ³•é”™è¯¯"
                SYNTAX_OK="false"
              fi
            fi
          done
          
          echo "syntax_ok=$SYNTAX_OK" >> $GITHUB_OUTPUT
          
          if [ "$SYNTAX_OK" = "false" ]; then
            echo -e "$ERRORS" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… æ‰€æœ‰æ–‡ä»¶è¯­æ³•æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ” Flake8 æ£€æŸ¥ï¼ˆä¸¥é‡é”™è¯¯ï¼‰
        if: steps.check_files.outputs.has_py_changes == 'true'
        run: |
          echo "## ğŸ” ä»£ç è´¨é‡æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          RESULT=$(flake8 $CHANGED_FILES --select=E9,F63,F7,F82 --format='%(path)s:%(row)d: %(code)s %(text)s' 2>/dev/null || true)
          if [ -n "$RESULT" ]; then
            echo "âš ï¸ å‘ç°ä»¥ä¸‹é—®é¢˜ï¼š" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$RESULT" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… æœªå‘ç°ä¸¥é‡ä»£ç é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ“Š å˜æ›´ç»Ÿè®¡
        run: |
          BASE_REF="${{ github.base_ref || 'main' }}"
          echo "## ğŸ“Š å˜æ›´ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          STATS=$(git diff --stat origin/$BASE_REF...HEAD 2>/dev/null | tail -1)
          echo "$STATS" >> $GITHUB_STEP_SUMMARY

  # ==================== AI ä»£ç å®¡æŸ¥ï¼ˆä¾èµ–é™æ€æ£€æŸ¥é€šè¿‡ï¼‰====================
  ai-review:
    name: ğŸ¤– AI ä»£ç å®¡æŸ¥
    runs-on: ubuntu-latest
    needs: [security-check, auto-check]
    if: |
      needs.security-check.outputs.safe_to_run == 'true' &&
      needs.auto-check.result == 'success' &&
      needs.auto-check.outputs.has_reviewable_changes == 'true' &&
      vars.ENABLE_AI_REVIEW != 'false'
    
    steps:
      # å…ˆæ£€å‡ºä¸»åˆ†æ”¯ï¼ˆè·å–æœ€æ–°çš„ .github/scriptsï¼‰
      - name: ğŸ“¥ æ£€å‡ºä¸»åˆ†æ”¯è„šæœ¬
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}
          sparse-checkout: |
            .github/scripts
          sparse-checkout-cone-mode: false
          path: main-scripts
      
      # å†æ£€å‡º PR ä»£ç ï¼ˆç”¨äº diff åˆ†æï¼‰
      - name: ğŸ“¥ æ£€å‡º PR ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0
          path: pr-code
      
      - name: ğŸ”„ è·å– base åˆ†æ”¯
        working-directory: pr-code
        run: git fetch origin ${{ github.base_ref || 'main' }}:refs/remotes/origin/${{ github.base_ref || 'main' }}
      
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pip install google-genai openai httpx
      
      - name: ğŸ¤– AI å®¡æŸ¥ä»£ç å˜æ›´
        working-directory: pr-code
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_BASE_REF: ${{ github.base_ref || 'main' }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL || 'gemini-2.5-flash' }}
          GEMINI_MODEL_FALLBACK: ${{ vars.GEMINI_MODEL_FALLBACK || 'gemini-2.5-flash' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ vars.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL }}
          AI_REVIEW_STRICT: ${{ vars.AI_REVIEW_STRICT || 'false' }}
        run: python ../main-scripts/.github/scripts/ai_review.py
      
      - name: ğŸ“¤ ä¸Šä¼ å®¡æŸ¥ç»“æœ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-review-result
          path: pr-code/ai_review_result.txt
          if-no-files-found: ignore

  # ==================== PR æ ‡ç­¾è‡ªåŠ¨åˆ†ç±» ====================
  labeler:
    name: ğŸ·ï¸ è‡ªåŠ¨æ ‡ç­¾
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ·ï¸ æ·»åŠ æ ‡ç­¾
        if: github.event_name == 'pull_request_target'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const labels = new Set();
            
            for (const file of files) {
              const filename = file.filename.toLowerCase();
              
              if (filename.includes('notification') || filename.includes('webhook')) {
                labels.add('notification');
              }
              if (filename.includes('feishu')) {
                labels.add('feishu');
              }
              if (filename.includes('data_provider') || filename.includes('fetcher')) {
                labels.add('data-source');
              }
              if (filename.includes('analyzer') || filename.includes('ai')) {
                labels.add('ai');
              }
              if (filename.endsWith('.md') || filename.includes('doc')) {
                labels.add('documentation');
              }
              if (filename.includes('workflow') || filename.includes('.github')) {
                labels.add('ci/cd');
              }
              if (filename.includes('config')) {
                labels.add('configuration');
              }
              if (filename.includes('test')) {
                labels.add('testing');
              }
            }
            
            const additions = files.reduce((sum, f) => sum + f.additions, 0);
            const deletions = files.reduce((sum, f) => sum + f.deletions, 0);
            const totalChanges = additions + deletions;
            
            if (totalChanges < 50) {
              labels.add('size/S');
            } else if (totalChanges < 200) {
              labels.add('size/M');
            } else if (totalChanges < 500) {
              labels.add('size/L');
            } else {
              labels.add('size/XL');
            }
            
            if (labels.size > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: Array.from(labels)
                });
                console.log(`Added labels: ${Array.from(labels).join(', ')}`);
              } catch (e) {
                console.log(`Failed to add labels: ${e.message}`);
              }
            }

  # ==================== è‡ªåŠ¨è¯„è®ºæ£€æŸ¥ç»“æœ ====================
  comment:
    name: ğŸ’¬ å®¡æŸ¥æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [security-check, auto-check, ai-review]
    if: always() && github.event_name == 'pull_request_target' && needs.security-check.outputs.safe_to_run == 'true'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¥ ä¸‹è½½ AI å®¡æŸ¥ç»“æœ
        uses: actions/download-artifact@v4
        if: needs.ai-review.result == 'success'
        continue-on-error: true
        with:
          name: ai-review-result
          path: .
      
      - name: ğŸ’¬ ç”Ÿæˆå®¡æŸ¥æŠ¥å‘Š
        env:
          AUTO_CHECK_RESULT: ${{ needs.auto-check.result }}
          AI_REVIEW_RESULT: ${{ needs.ai-review.result }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const additions = files.reduce((sum, f) => sum + f.additions, 0);
            const deletions = files.reduce((sum, f) => sum + f.deletions, 0);
            const changedFiles = files.length;
            
            let aiReview = '';
            try {
              aiReview = fs.readFileSync('ai_review_result.txt', 'utf8');
            } catch (e) {
              console.log('No AI review result found');
            }
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('## ğŸ¤– è‡ªåŠ¨å®¡æŸ¥æŠ¥å‘Š')
            );
            
            const checkStatus = process.env.AUTO_CHECK_RESULT === 'success' ? 'âœ… é€šè¿‡' : 'âš ï¸ æœ‰é—®é¢˜';
            const aiStatus = process.env.AI_REVIEW_RESULT === 'success' ? 'âœ… å·²å®Œæˆ' : 
                            process.env.AI_REVIEW_RESULT === 'skipped' ? 'â­ï¸ è·³è¿‡' : 'âš ï¸ å¤±è´¥';
            
            let report = `## ğŸ¤– è‡ªåŠ¨å®¡æŸ¥æŠ¥å‘Š

            | é¡¹ç›® | ç»“æœ |
            |------|------|
            | ğŸ“Š å˜æ›´æ–‡ä»¶ | ${changedFiles} ä¸ª |
            | â• æ–°å¢è¡Œæ•° | ${additions} è¡Œ |
            | â– åˆ é™¤è¡Œæ•° | ${deletions} è¡Œ |
            | ğŸ” é™æ€æ£€æŸ¥ | ${checkStatus} |
            | ğŸ§  AI å®¡æŸ¥ | ${aiStatus} |

            ### ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

            `;
            
            for (const file of files.slice(0, 20)) {
              const status = file.status === 'added' ? 'ğŸ†•' : 
                            file.status === 'removed' ? 'ğŸ—‘ï¸' : 'ğŸ“';
              report += `- ${status} \`${file.filename}\` (+${file.additions}/-${file.deletions})\n`;
            }
            
            if (files.length > 20) {
              report += `\n... è¿˜æœ‰ ${files.length - 20} ä¸ªæ–‡ä»¶\n`;
            }
            
            if (aiReview) {
              report += `
            ---

            ### ğŸ§  AI ä»£ç å®¡æŸ¥æ„è§

            ${aiReview}
            `;
            }
            
            report += `
            ---

            > ğŸ’¡ **æç¤º**: è¯·ç¡®ä¿ä»£ç å·²é€šè¿‡æœ¬åœ°æµ‹è¯•ï¼Œå¹¶éµå¾ªé¡¹ç›®ä»£ç è§„èŒƒã€‚
            `;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }
